<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <style>
        /* Стили для тултипов */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .global-tooltip {
            position: fixed;
            z-index: 99999;
            background-color: #1f2937;
            color: white;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 400px;
            min-width: 320px;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            pointer-events: none;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .global-tooltip.show {
            visibility: visible;
            opacity: 1;
        }

        .global-tooltip .tooltip-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #1f2937;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
        }
    </style>
</head>
<body>
<!-- Блок для сортировки по периоду -->
<div class="bg-white rounded-lg shadow p-4 mb-4">
    <form th:action="@{/grades}" method="get">
        <div class="row align-items-center">
            <div class="col-md-4 mb-2">
                <label for="quarter" class="form-label">Период:</label>
                <select name="quarter" id="quarter" onchange="this.form.submit()"
                        class="form-select">
                    <option th:each="q : ${viewModel.availableQuarters}"
                            th:value="${q}"
                            th:text="${q == 'Итоговые оценки' ? q : q + ' Четверть'}"
                            th:selected="${q == viewModel.selectedQuarter}"></option>
                </select>
            </div>
            <input type="hidden" name="classId" value="" />
            <input type="hidden" name="subjectId" value="" />
        </div>
    </form>
</div>

<!-- Информация об ученике -->
<div class="bg-white rounded-lg shadow p-4 mb-4">
    <div class="row">
        <div class="col-md-6 mb-3">
            <p class="text-muted mb-1">
                <span th:text="${viewModel.parentView ? 'Ваш ребенок' : 'Ученик'}">Ученик</span>:
            </p>
            <p class="h5 mb-0" th:text="${viewModel.studentFullName}">Иванов Алексей Петрович</p>
        </div>
        <div class="col-md-6">
            <p class="text-muted mb-1">Класс:</p>
            <p class="h5 mb-0" th:text="${viewModel.className}">9 "А"</p>
        </div>
    </div>
</div>

<!-- Таблица с данными -->
<div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
            <tr>
                <th scope="col" class="text-nowrap">№</th>
                <th scope="col" class="text-nowrap">Предмет</th>
                <th scope="col" class="text-nowrap">
                            <span th:if="${viewModel.selectedQuarter == 'Итоговые оценки'}">
                                Ср. балл итоговых (Год)
                            </span>
                    <span th:unless="${viewModel.selectedQuarter == 'Итоговые оценки'}">
                                Средний балл (Четверть)
                            </span>
                </th>
                <th scope="col" class="text-nowrap">
                            <span th:if="${viewModel.selectedQuarter == 'Итоговые оценки'}">
                                <strong>Годовая Оценка</strong>
                            </span>
                    <span th:unless="${viewModel.selectedQuarter == 'Итоговые оценки'}">
                                <strong>Итоговая Оценка</strong>
                            </span>
                </th>
                <th scope="col" class="text-nowrap">Пропуски</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item, stat : ${viewModel.subjects}">
                <td class="align-middle" th:text="${stat.count}">1</td>
                <td class="align-middle" th:text="${item.subjectName}">Математика</td>

                <!-- Ячейка со средним баллом и тултипом -->
                <td class="align-middle">
                            <span th:classappend="${item.quarterFinalGrade >= 4.0 ? 'text-success fw-bold' :
                                                   (item.quarterFinalGrade >= 3.0 ? 'text-warning fw-bold' : 'text-danger fw-bold')}">
                                <span th:if="${item.gradeCount > 0}"
                                      class="tooltip-trigger text-decoration-none"
                                      style="cursor: help;"
                                      data-tooltip-type="grades"
                                      th:attr="data-subject-name=${item.subjectName},
                                               data-average-grade=${#numbers.formatDecimal(item.averageGrade, 1, 2)},
                                               data-final-grade=${item.quarterFinalGrade},
                                               data-grade-count=${item.gradeCount},
                                               data-all-grades=${item.allGradesString},
                                               data-grade5=${item.gradeCount5},
                                               data-grade4=${item.gradeCount4},
                                               data-grade3=${item.gradeCount3},
                                               data-grade2=${item.gradeCount2},
                                               data-grade1=${item.gradeCount1},
                                               data-grade0=${item.gradeCount0},
                                               data-percent5=${#numbers.formatDecimal(item.percent5, 1, 1)},
                                               data-percent4=${#numbers.formatDecimal(item.percent4, 1, 1)},
                                               data-percent3=${#numbers.formatDecimal(item.percent3, 1, 1)},
                                               data-percent2=${#numbers.formatDecimal(item.percent2, 1, 1)},
                                               data-percent1=${#numbers.formatDecimal(item.percent1, 1, 1)},
                                               data-percent0=${#numbers.formatDecimal(item.percent0, 1, 1)}">
                                    <span th:text="${#numbers.formatDecimal(item.averageGrade, 1, 2)}">4.25</span>
                                    <small class="text-muted ms-1">(наведите для деталей)</small>
                                </span>
                                <span th:unless="${item.gradeCount > 0}"
                                      th:text="${#numbers.formatDecimal(item.averageGrade, 1, 2)}">4.25</span>
                            </span>
                </td>

                <!-- Итоговая оценка -->
                <td class="align-middle">
                            <span th:classappend="${item.quarterFinalGrade < 3 ? 'text-danger fw-bold fs-5' : 'text-success fw-bold fs-5'}"
                                  th:text="${item.quarterFinalGrade}">4</span>
                </td>

                <!-- Ячейка с пропусками и тултипом -->
                <td class="align-middle">
                            <span th:if="${item.totalAbsences > 0}"
                                  class="tooltip-trigger text-decoration-none"
                                  style="cursor: help;"
                                  data-tooltip-type="absences"
                                  th:attr="data-subject-name=${item.subjectName},
                                           data-total-absences=${item.totalAbsences},
                                           data-absent-h=${item.absentTypeH},
                                           data-absent-u=${item.absentTypeU},
                                           data-absent-b=${item.absentTypeB},
                                           data-total-lessons=${item.totalLessonsInPeriod}">
                                <span th:text="${item.totalAbsences}">3</span>
                                <small class="text-muted ms-1">(наведите для деталей)</small>
                            </span>
                    <span th:unless="${item.totalAbsences > 0}"
                          th:text="${item.totalAbsences}">0</span>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Глобальный тултип (будет создан динамически) -->
<div id="globalTooltip" class="global-tooltip"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function () {
        // Обработка изменения селекта
        document.getElementById('quarter').addEventListener('change', function () {
            this.form.submit();
        });

        // Создаем глобальный тултип, если его нет
        let tooltip = document.getElementById('globalTooltip');
        if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.id = 'globalTooltip';
            tooltip.className = 'global-tooltip';
            document.body.appendChild(tooltip);
        }

        let tooltipVisible = false;
        let currentTrigger = null;

        // Обработчики для тултипов
        const allTriggers = document.querySelectorAll('.tooltip-trigger');

        allTriggers.forEach(trigger => {
            // При наведении
            trigger.addEventListener('mouseenter', function (e) {
                currentTrigger = this;
                const type = this.getAttribute('data-tooltip-type');

                let tooltipContent = '';

                if (type === 'grades') {
                    // Генерируем контент для оценок
                    const subjectName = this.getAttribute('data-subject-name');
                    const averageGrade = this.getAttribute('data-average-grade');
                    const finalGrade = this.getAttribute('data-final-grade');
                    const gradeCount = this.getAttribute('data-grade-count');
                    const allGrades = this.getAttribute('data-all-grades');

                    tooltipContent = `
                        <div class="fw-bold mb-2 border-bottom pb-1">Детализация оценок по предмету:</div>
                        <div class="text-light mb-1">${subjectName}</div>
                        <div class="mb-2">
                            <div class="text-light mb-1">Всего оценок: <span class="fw-bold">${gradeCount}</span></div>
                            <div class="small text-secondary mb-2">Все оценки: <span class="fw-bold">[${allGrades}]</span></div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-success me-2" style="width: 20px; height: 20px;"></span>
                                    <span>Отлично (5):</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="fw-bold me-2">${this.getAttribute('data-grade5')}</span>
                                    <span class="small text-secondary">(${this.getAttribute('data-percent5')}%)</span>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-primary me-2" style="width: 20px; height: 20px;"></span>
                                    <span>Хорошо (4):</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="fw-bold me-2">${this.getAttribute('data-grade4')}</span>
                                    <span class="small text-secondary">(${this.getAttribute('data-percent4')}%)</span>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-warning me-2" style="width: 20px; height: 20px;"></span>
                                    <span>Удовлетворительно (3):</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="fw-bold me-2">${this.getAttribute('data-grade3')}</span>
                                    <span class="small text-secondary">(${this.getAttribute('data-percent3')}%)</span>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-danger me-2" style="width: 20px; height: 20px;"></span>
                                    <span>Неудовлетворительно (2):</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="fw-bold me-2">${this.getAttribute('data-grade2')}</span>
                                    <span class="small text-secondary">(${this.getAttribute('data-percent2')}%)</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 pt-2 border-top">
                            <div class="d-flex justify-content-between fw-bold mb-1">
                                <span>Средний балл:</span>
                                <span class="${averageGrade >= 4.0 ? 'text-success' : (averageGrade >= 3.0 ? 'text-warning' : 'text-danger')}">
                                    ${averageGrade}
                                </span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Итоговая оценка:</span>
                                <span class="fw-bold ${finalGrade < 3 ? 'text-danger' : 'text-success'}">
                                    ${finalGrade}
                                </span>
                            </div>
                        </div>
                        <div class="tooltip-arrow"></div>`;
                } else if (type === 'absences') {
                    // Генерируем контент для пропусков
                    const subjectName = this.getAttribute('data-subject-name');
                    const totalAbsences = this.getAttribute('data-total-absences');
                    const absentH = this.getAttribute('data-absent-h');
                    const absentU = this.getAttribute('data-absent-u');
                    const absentB = this.getAttribute('data-absent-b');
                    const totalLessons = this.getAttribute('data-total-lessons');

                    tooltipContent = `
                        <div class="fw-bold mb-2 border-bottom pb-1">Детализация пропусков по предмету:</div>
                        <div class="text-light mb-1">${subjectName}</div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="text-danger">Неуважительные (Н):</span>
                                <span class="fw-bold">${absentH}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="text-warning">Уважительные (У):</span>
                                <span class="fw-bold">${absentU}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-info">Болезнь (Б):</span>
                                <span class="fw-bold">${absentB}</span>
                            </div>
                        </div>
                        <div class="mt-3 pt-2 border-top">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Всего пропусков:</span>
                                <span class="fw-bold">${totalAbsences}</span>
                            </div>`;

                    if (totalLessons > 0) {
                        const attendanceRate = 100 - (totalAbsences / totalLessons * 100);
                        tooltipContent += `
                            <div class="d-flex justify-content-between mb-1">
                                <span>Всего уроков:</span>
                                <span class="fw-bold">${totalLessons}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Посещаемость:</span>
                                <span class="fw-bold">${attendanceRate.toFixed(1)}%</span>
                            </div>`;
                    }

                    tooltipContent += `
                        </div>
                        <div class="tooltip-arrow"></div>`;
                }

                // Устанавливаем контент
                tooltip.innerHTML = tooltipContent;

                // Показываем тултип
                tooltip.classList.add('show');
                tooltipVisible = true;

                // Позиционируем тултип
                positionTooltip(e);
            });

            // При движении мыши
            trigger.addEventListener('mousemove', function (e) {
                if (tooltipVisible && currentTrigger === this) {
                    positionTooltip(e);
                }
            });

            // При уходе мыши
            trigger.addEventListener('mouseleave', function () {
                if (tooltipVisible && currentTrigger === this) {
                    tooltip.classList.remove('show');
                    tooltipVisible = false;
                    currentTrigger = null;
                }
            });
        });

        // Функция для позиционирования тултипа
        function positionTooltip(e) {
            if (!tooltipVisible || !currentTrigger) return;

            const mouseX = e.clientX;
            const mouseY = e.clientY;
            const tooltipRect = tooltip.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            let left = mouseX + 15;
            let top = mouseY + 15;

            // Проверяем границы экрана
            if (left + tooltipRect.width > viewportWidth - 10) {
                left = mouseX - tooltipRect.width - 15;
            }
            if (left < 10) left = 10;
            if (top + tooltipRect.height > viewportHeight - 10) {
                top = mouseY - tooltipRect.height - 15;
            }
            if (top < 10) top = 10;

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.style.right = 'auto';
            tooltip.style.bottom = 'auto';
            tooltip.style.transform = 'none';
        }

        // Закрытие тултипов при скролле и ресайзе
        document.addEventListener('scroll', function () {
            if (tooltipVisible) {
                tooltip.classList.remove('show');
                tooltipVisible = false;
                currentTrigger = null;
            }
        });

        window.addEventListener('resize', function () {
            if (tooltipVisible) {
                tooltip.classList.remove('show');
                tooltipVisible = false;
                currentTrigger = null;
            }
        });
    });
    /*]]>*/
</script>
</body>
</html>