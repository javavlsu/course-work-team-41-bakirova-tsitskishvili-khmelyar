<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Основные стили */
        .lesson-cell {
            min-height: 120px;
            padding: 8px !important;
            vertical-align: top !important;
        }

        .lesson-card {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 12px;
            height: 100%;
        }

        .grade-badge {
            transition: all 0.2s ease;
        }

        .grade-badge:hover {
            transform: scale(1.05);
        }

        .homework-link {
            cursor: pointer;
            color: #0d6efd !important;
            text-decoration: none !important;
        }

        .homework-link:hover {
            color: #0a58ca !important;
            text-decoration: underline !important;
        }

        /* Дополнительные стили для исправления интерфейса */
        .sidebar-menu-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            padding-left: 0.5rem;
        }

        /* Горизонтальная прокрутка расписания */
        .schedule-scroll-container {
            overflow-x: auto;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            margin: 0 -1rem;
            padding: 0 1rem;
        }

        .schedule-scroll-container::-webkit-scrollbar {
            height: 8px;
        }

        .schedule-scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .schedule-scroll-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .schedule-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Фиксированная первая колонка (время) */
        .fixed-time-column {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 10;
            min-width: 120px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }

        /* Адаптивные ячейки */
        .lesson-cell {
            min-width: 200px;
            max-width: 300px;
        }

        /* Индикатор прокрутки */
        .scroll-indicator {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(13, 110, 253, 0.1);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: bounce 2s infinite;
            z-index: 5;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(-50%) translateX(0); }
            50% { transform: translateY(-50%) translateX(-5px); }
        }

        /* Улучшенное модальное окно */
        .homework-modal-centered .modal-dialog {
            min-height: calc(100vh - 60px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .homework-modal-centered .modal-content {
            max-height: calc(100vh - 60px);
            overflow-y: auto;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .modal-header {
            border-radius: 12px 12px 0 0;
        }

        /* Подсказка о прокрутке */
        .scroll-hint {
            background: linear-gradient(90deg, rgba(13,110,253,0.1) 0%, rgba(13,110,253,0.05) 100%);
            border-left: 4px solid #0d6efd;
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
        }

        /* Кнопки навигации по неделям улучшены */
        .week-nav-btn {
            min-width: 140px;
            padding: 8px 16px;
        }

        /* Для мобильных устройств */
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.85rem;
            }

            .lesson-cell {
                min-height: 100px;
                padding: 4px !important;
                min-width: 180px;
                max-width: 250px;
            }

            .lesson-card {
                padding: 8px;
            }

            .fixed-time-column {
                min-width: 100px;
            }

            .week-nav-btn {
                min-width: auto;
                padding: 6px 12px;
            }
        }

        @media (max-width: 576px) {
            .schedule-scroll-container {
                margin: 0 -0.5rem;
                padding: 0 0.5rem;
            }

            .scroll-hint {
                font-size: 0.8rem;
                padding: 8px 12px;
            }
        }

        /* Дополнительные утилиты */
        .min-h-100 {
            min-height: 100px;
        }

        .border-primary {
            border-color: #0d6efd !important;
        }

        .bg-primary {
            background-color: #0d6efd !important;
        }

        .text-primary {
            color: #0d6efd !important;
        }
    </style>
</head>
<body>

<!-- Навигация по неделям -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex flex-wrap align-items-center gap-3">
                    <a th:href="@{/schedule/index(date=${viewModel.startOfWeek.minusDays(7).toString()})}"
                       class="btn btn-outline-secondary week-nav-btn">
                        <i class="fas fa-chevron-left me-1"></i> Пред. неделя
                    </a>

                    <div class="text-center">
                        <h5 class="mb-0 fw-bold">
                            <span th:text="${#temporals.format(viewModel.startOfWeek, 'dd.MM.yyyy')}"></span> -
                            <span th:text="${#temporals.format(viewModel.startOfWeek.plusDays(6), 'dd.MM.yyyy')}"></span>
                        </h5>
                    </div>

                    <a th:href="@{/schedule/index(date=${viewModel.startOfWeek.plusDays(7).toString()})}"
                       class="btn btn-outline-secondary week-nav-btn">
                        След. неделя <i class="fas fa-chevron-right ms-1"></i>
                    </a>
                </div>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <a th:href="@{/schedule/index}"
                   class="btn btn-primary">
                    <i class="fas fa-calendar-day me-2"></i> Текущая неделя
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Сообщение об ошибке -->
<div th:if="${errorMessage}" class="alert alert-warning alert-dismissible fade show mb-4" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <span th:text="${errorMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<!-- Таблица расписания -->
<div class="card shadow-lg border-0">
    <div class="card-body p-0 position-relative">
        <!-- Подсказка о горизонтальной прокрутке -->
        <div class="scroll-hint d-flex align-items-center d-md-none">
            <i class="fas fa-arrow-left-right me-2 text-primary"></i>
            <span class="small">Листайте вбок для просмотра всех дней →</span>
        </div>

        <!-- Индикатор прокрутки (только для десктопов) -->
        <div class="scroll-indicator d-none d-md-block">
            <i class="fas fa-chevron-right text-primary"></i>
        </div>

        <div class="schedule-scroll-container">
            <table class="table table-hover mb-0">
                <thead class="table-primary">
                <tr>
                    <th class="text-center align-middle fixed-time-column" style="width: 120px;">Время</th>
                    <!-- Статические заголовки дней с датами -->
                    <th class="text-center align-middle lesson-cell">
                        <div class="fw-bold">Пн</div>
                        <small class="text-muted" th:text="${#temporals.format(viewModel.startOfWeek, 'dd.MM')}"></small>
                    </th>
                    <th class="text-center align-middle lesson-cell">
                        <div class="fw-bold">Вт</div>
                        <small class="text-muted" th:text="${#temporals.format(viewModel.startOfWeek.plusDays(1), 'dd.MM')}"></small>
                    </th>
                    <th class="text-center align-middle lesson-cell">
                        <div class="fw-bold">Ср</div>
                        <small class="text-muted" th:text="${#temporals.format(viewModel.startOfWeek.plusDays(2), 'dd.MM')}"></small>
                    </th>
                    <th class="text-center align-middle lesson-cell">
                        <div class="fw-bold">Чт</div>
                        <small class="text-muted" th:text="${#temporals.format(viewModel.startOfWeek.plusDays(3), 'dd.MM')}"></small>
                    </th>
                    <th class="text-center align-middle lesson-cell">
                        <div class="fw-bold">Пт</div>
                        <small class="text-muted" th:text="${#temporals.format(viewModel.startOfWeek.plusDays(4), 'dd.MM')}"></small>
                    </th>
                    <th class="text-center align-middle lesson-cell">
                        <div class="fw-bold">Сб</div>
                        <small class="text-muted" th:text="${#temporals.format(viewModel.startOfWeek.plusDays(5), 'dd.MM')}"></small>
                    </th>
                </tr>
                </thead>
                <tbody>
                <!-- Максимум 6 уроков в день -->
                <tr th:each="lessonNum : ${#numbers.sequence(1, 6)}"
                    th:class="${lessonNum % 2 == 0} ? 'table-light' : ''">
                    <td class="align-middle p-3 border-end fixed-time-column">
                        <div class="fw-bold text-primary mb-1">Урок <span th:text="${lessonNum}"></span></div>
                        <small class="text-muted" th:text="${lessonTimes[lessonNum]}">08:30 - 10:00</small>
                    </td>

                    <!-- Понедельник -->
                    <td class="lesson-cell border-end">
                        <div th:each="lesson : ${viewModel.scheduleByDay[T(java.time.DayOfWeek).MONDAY]}"
                             th:if="${lesson.lessonNumber == lessonNum}">
                            <div class="lesson-card">
                                <div class="fw-bold text-primary mb-1" th:text="${lesson.subjectName}"></div>
                                <div class="text-muted small mb-2" th:text="${lesson.teacherFullName}"></div>
                                <div class="text-muted small mb-2">
                                    <i class="fas fa-door-open me-1"></i>Каб. <span th:text="${lesson.classroom}"></span>
                                </div>

                                <!-- Оценка -->
                                <div th:if="${lesson.grade != null}" class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted small">Оценка:</span>
                                        <span th:class="${lesson.grade >= 4} ? 'badge bg-success' :
                                                          (${lesson.grade == 3} ? 'badge bg-warning text-dark' :
                                                          'badge bg-danger')"
                                              class="grade-badge">
                                                <span th:text="${lesson.grade}"></span>
                                                <i th:if="${lesson.gradeComment}" class="fas fa-info-circle ms-1"
                                                   data-bs-toggle="tooltip" th:title="${lesson.gradeComment}"></i>
                                            </span>
                                    </div>
                                </div>

                                <!-- Тема урока -->
                                <div th:if="${lesson.lessonTopic}" class="mt-2 pt-2 border-top">
                                    <div class="text-muted small">Тема:</div>
                                    <div class="small text-truncate" th:text="${lesson.lessonTopic}"></div>
                                </div>

                                <!-- Домашнее задание -->
                                <div th:if="${lesson.homeworkText}" class="mt-2 pt-2 border-top">
                                    <div class="text-muted small">Д/З:</div>
                                    <div th:unless="${isParent}"
                                         class="small homework-link text-truncate"
                                         th:attr="data-lesson-id=${lesson.scheduleId}"
                                         onclick="openHomeworkModal(this)">
                                        <span th:text="${lesson.homeworkText}"></span>
                                    </div>
                                    <div th:if="${isParent}" class="small text-truncate">
                                        <span th:text="${lesson.homeworkText}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>

                    <!-- Вторник -->
                    <td class="lesson-cell border-end">
                        <div th:each="lesson : ${viewModel.scheduleByDay[T(java.time.DayOfWeek).TUESDAY]}"
                             th:if="${lesson.lessonNumber == lessonNum}">
                            <div class="lesson-card">
                                <div class="fw-bold text-primary mb-1" th:text="${lesson.subjectName}"></div>
                                <div class="text-muted small mb-2" th:text="${lesson.teacherFullName}"></div>
                                <div class="text-muted small mb-2">
                                    <i class="fas fa-door-open me-1"></i>Каб. <span th:text="${lesson.classroom}"></span>
                                </div>

                                <!-- Тема урока -->
                                <div th:if="${lesson.lessonTopic}" class="mt-2 pt-2 border-top">
                                    <div class="text-muted small">Тема:</div>
                                    <div class="small text-truncate" th:text="${lesson.lessonTopic}"></div>
                                </div>

                                <!-- Домашнее задание -->
                                <div th:if="${lesson.homeworkText}" class="mt-2 pt-2 border-top">
                                    <div class="text-muted small">Д/З:</div>
                                    <div th:unless="${isParent}"
                                         class="small homework-link text-truncate"
                                         th:attr="data-lesson-id=${lesson.scheduleId}"
                                         onclick="openHomeworkModal(this)">
                                        <span th:text="${lesson.homeworkText}"></span>
                                    </div>
                                    <div th:if="${isParent}" class="small text-truncate">
                                        <span th:text="${lesson.homeworkText}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>

                    <!-- Среда -->
                    <td class="lesson-cell border-end">
                        <div th:each="lesson : ${viewModel.scheduleByDay[T(java.time.DayOfWeek).WEDNESDAY]}"
                             th:if="${lesson.lessonNumber == lessonNum}">
                            <div class="lesson-card">
                                <div class="fw-bold text-primary mb-1" th:text="${lesson.subjectName}"></div>
                                <div class="text-muted small mb-2" th:text="${lesson.teacherFullName}"></div>
                                <div class="text-muted small mb-2">
                                    <i class="fas fa-door-open me-1"></i>Каб. <span th:text="${lesson.classroom}"></span>
                                </div>

                                <!-- Тема урока -->
                                <div th:if="${lesson.lessonTopic}" class="mt-2 pt-2 border-top">
                                    <div class="text-muted small">Тема:</div>
                                    <div class="small text-truncate" th:text="${lesson.lessonTopic}"></div>
                                </div>

                                <!-- Домашнее задание -->
                                <div th:if="${lesson.homeworkText}" class="mt-2 pt-2 border-top">
                                    <div class="text-muted small">Д/З:</div>
                                    <div th:unless="${isParent}"
                                         class="small homework-link text-truncate"
                                         th:attr="data-lesson-id=${lesson.scheduleId}"
                                         onclick="openHomeworkModal(this)">
                                        <span th:text="${lesson.homeworkText}"></span>
                                    </div>
                                    <div th:if="${isParent}" class="small text-truncate">
                                        <span th:text="${lesson.homeworkText}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>

                    <!-- Четверг -->
                    <td class="lesson-cell border-end">
                        <div th:each="lesson : ${viewModel.scheduleByDay[T(java.time.DayOfWeek).THURSDAY]}"
                             th:if="${lesson.lessonNumber == lessonNum}">
                            <div class="lesson-card">
                                <div class="fw-bold text-primary mb-1" th:text="${lesson.subjectName}"></div>
                                <div class="text-muted small mb-2" th:text="${lesson.teacherFullName}"></div>
                                <div class="text-muted small mb-2">
                                    <i class="fas fa-door-open me-1"></i>Каб. <span th:text="${lesson.classroom}"></span>
                                </div>

                                <!-- Тема урока -->
                                <div th:if="${lesson.lessonTopic}" class="mt-2 pt-2 border-top">
                                    <div class="text-muted small">Тема:</div>
                                    <div class="small text-truncate" th:text="${lesson.lessonTopic}"></div>
                                </div>

                                <!-- Домашнее задание -->
                                <div th:if="${lesson.homeworkText}" class="mt-2 pt-2 border-top">
                                    <div class="text-muted small">Д/З:</div>
                                    <div th:unless="${isParent}"
                                         class="small homework-link text-truncate"
                                         th:attr="data-lesson-id=${lesson.scheduleId}"
                                         onclick="openHomeworkModal(this)">
                                        <span th:text="${lesson.homeworkText}"></span>
                                    </div>
                                    <div th:if="${isParent}" class="small text-truncate">
                                        <span th:text="${lesson.homeworkText}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>

                    <!-- Пятница -->
                    <td class="lesson-cell border-end">
                        <div th:each="lesson : ${viewModel.scheduleByDay[T(java.time.DayOfWeek).FRIDAY]}"
                             th:if="${lesson.lessonNumber == lessonNum}">
                            <div class="lesson-card">
                                <div class="fw-bold text-primary mb-1" th:text="${lesson.subjectName}"></div>
                                <div class="text-muted small mb-2" th:text="${lesson.teacherFullName}"></div>
                                <div class="text-muted small mb-2">
                                    <i class="fas fa-door-open me-1"></i>Каб. <span th:text="${lesson.classroom}"></span>
                                </div>

                                <!-- Тема урока -->
                                <div th:if="${lesson.lessonTopic}" class="mt-2 pt-2 border-top">
                                    <div class="text-muted small">Тема:</div>
                                    <div class="small text-truncate" th:text="${lesson.lessonTopic}"></div>
                                </div>

                                <!-- Домашнее задание -->
                                <div th:if="${lesson.homeworkText}" class="mt-2 pt-2 border-top">
                                    <div class="text-muted small">Д/З:</div>
                                    <div th:unless="${isParent}"
                                         class="small homework-link text-truncate"
                                         th:attr="data-lesson-id=${lesson.scheduleId}"
                                         onclick="openHomeworkModal(this)">
                                        <span th:text="${lesson.homeworkText}"></span>
                                    </div>
                                    <div th:if="${isParent}" class="small text-truncate">
                                        <span th:text="${lesson.homeworkText}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>

                    <!-- Суббота -->
                    <td class="lesson-cell border-end">
                        <div th:each="lesson : ${viewModel.scheduleByDay[T(java.time.DayOfWeek).SATURDAY]}"
                             th:if="${lesson.lessonNumber == lessonNum}">
                            <div class="lesson-card">
                                <div class="fw-bold text-primary mb-1" th:text="${lesson.subjectName}"></div>
                                <div class="text-muted small mb-2" th:text="${lesson.teacherFullName}"></div>
                                <div class="text-muted small mb-2">
                                    <i class="fas fa-door-open me-1"></i>Каб. <span th:text="${lesson.classroom}"></span>
                                </div>

                                <!-- Тема урока -->
                                <div th:if="${lesson.lessonTopic}" class="mt-2 pt-2 border-top">
                                    <div class="text-muted small">Тема:</div>
                                    <div class="small text-truncate" th:text="${lesson.lessonTopic}"></div>
                                </div>

                                <!-- Домашнее задание -->
                                <div th:if="${lesson.homeworkText}" class="mt-2 pt-2 border-top">
                                    <div class="text-muted small">Д/З:</div>
                                    <div th:unless="${isParent}"
                                         class="small homework-link text-truncate"
                                         th:attr="data-lesson-id=${lesson.scheduleId}"
                                         onclick="openHomeworkModal(this)">
                                        <span th:text="${lesson.homeworkText}"></span>
                                    </div>
                                    <div th:if="${isParent}" class="small text-truncate">
                                        <span th:text="${lesson.homeworkText}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Сообщение при отсутствии расписания -->
        <div th:if="${viewModel.scheduleByDay == null || viewModel.scheduleByDay.isEmpty()}"
             class="text-center p-5">
            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
            <p class="h5 text-muted">На эту неделю расписание не составлено</p>
        </div>
    </div>
</div>

<!-- Модальное окно домашнего задания -->
<div class="modal fade homework-modal-centered" id="homeworkModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="homeworkModalTitle">
                    <span th:if="${isParent}">Просмотр домашнего задания</span>
                    <span th:unless="${isParent}">Домашнее задание</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Информация об уроке -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card border-primary">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <p class="text-muted small mb-1">Предмет</p>
                                        <p class="fw-bold mb-0 text-primary" id="modalSubject">—</p>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <p class="text-muted small mb-1">Дата</p>
                                        <p class="fw-bold mb-0" id="modalDate">—</p>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <p class="text-muted small mb-1">Урок</p>
                                        <p class="fw-bold mb-0" id="modalLessonNumber">—</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="text-muted small mb-1">Учитель</p>
                                        <p class="fw-bold mb-0" id="modalTeacher">—</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="text-muted small mb-1">Кабинет</p>
                                        <p class="fw-bold mb-0" id="modalClassroom">—</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Тема урока -->
                <div class="mb-4">
                    <label class="form-label fw-bold mb-2">
                        <i class="fas fa-book-open me-2 text-primary"></i>Тема урока:
                    </label>
                    <div class="p-3 bg-light rounded border min-h-100">
                        <p class="mb-0" id="modalLessonTopic">Не указана</p>
                    </div>
                </div>

                <!-- Домашнее задание -->
                <div class="mb-4">
                    <label class="form-label fw-bold mb-2">
                        <i class="fas fa-home me-2 text-primary"></i>Домашнее задание:
                    </label>
                    <div class="p-3 bg-light rounded border min-h-100">
                        <p class="mb-0" id="modalHomeworkText">Не задано</p>
                    </div>
                </div>

                <!-- Форма отправки ТОЛЬКО для учеников -->
                <div th:unless="${isParent}">
                    <hr class="my-4">
                    <h6 class="mb-3">
                        <i class="fas fa-paper-plane me-2 text-success"></i>Отправка выполненного задания
                    </h6>

                    <form id="submitHomeworkForm">
                        <input type="hidden" id="modalLessonId" name="lessonId">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                        <div class="mb-3">
                            <label for="studentAnswer" class="form-label fw-bold">
                                <i class="fas fa-edit me-1"></i>Ваш ответ (текст)
                            </label>
                            <textarea id="studentAnswer" name="studentAnswer" rows="4"
                                      class="form-control"
                                      placeholder="Введите ваш ответ или комментарий..."
                                      required></textarea>
                        </div>

                        <div id="submissionMessage" class="alert d-none"></div>

                        <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Закрыть
                            </button>
                            <button type="submit" id="submitHomeworkButton"
                                    class="btn btn-success px-4">
                                <i class="fas fa-paper-plane me-2"></i>Отправить задание
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Сообщение для родителей -->
                <div th:if="${isParent}">
                    <hr class="my-4">
                    <div class="alert alert-info border-0">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle fa-lg me-3"></i>
                            <div>
                                <p class="fw-bold mb-1">Информация для родителей</p>
                                <p class="mb-0">Для отправки домашнего задания необходимо войти в систему под учетной записью ученика.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Уведомления -->
<div id="notificationContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1100;"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    // Данные для JavaScript
    const scheduleServerData = {
        submitHomeworkUrl: '/schedule/submit-homework',
        scheduleIndexUrl: '/schedule/index',
        todayDate: /*[[${currentDate}]]*/ '',
        isParent: /*[[${isParent}]]*/ false,
        getLessonDetailsUrl: '/schedule/get-lesson-details'
    };

    // Инициализация Bootstrap компонентов
    let homeworkModal;
    let tooltips = [];

    document.addEventListener('DOMContentLoaded', function() {
        // Инициализация модального окна
        const modalElement = document.getElementById('homeworkModal');
        if (modalElement) {
            homeworkModal = new bootstrap.Modal(modalElement);
        }

        // Инициализация tooltip'ов
        const tooltipElements = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltips = tooltipElements.map(function (el) {
            return new bootstrap.Tooltip(el);
        });

        // Обработка отправки формы домашнего задания
        const submitHomeworkForm = document.getElementById('submitHomeworkForm');
        if (submitHomeworkForm) {
            submitHomeworkForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const submitButton = document.getElementById('submitHomeworkButton');
                const originalText = submitButton.innerHTML;
                const messageDiv = document.getElementById('submissionMessage');

                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Отправка...';
                submitButton.disabled = true;

                if (messageDiv) {
                    messageDiv.classList.add('d-none');
                }

                try {
                    const lessonId = document.getElementById('modalLessonId').value;
                    const studentAnswer = document.getElementById('studentAnswer').value;
                    const csrfToken = document.querySelector('input[name="_csrf"]').value;

                    if (!studentAnswer.trim()) {
                        showAlert('Пожалуйста, введите ответ', 'warning', messageDiv);
                        return;
                    }

                    const formData = new URLSearchParams();
                    formData.append('lessonId', lessonId);
                    formData.append('studentAnswer', studentAnswer);

                    const response = await fetch(scheduleServerData.submitHomeworkUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRF-TOKEN': csrfToken
                        },
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        showNotification(result.message || 'Задание успешно отправлено!', 'success');
                        setTimeout(() => {
                            if (homeworkModal) {
                                homeworkModal.hide();
                            }
                        }, 1500);
                    } else {
                        showAlert(result.message || 'Ошибка при отправке задания', 'danger', messageDiv);
                    }
                } catch (error) {
                    console.error('Ошибка отправки:', error);
                    showAlert('Ошибка сети. Пожалуйста, попробуйте позже.', 'danger', messageDiv);
                } finally {
                    submitButton.innerHTML = originalText;
                    submitButton.disabled = false;
                }
            });
        }

        // Инициализация функций для улучшения UX
        initScheduleScroll();
        setupModalAutoFocus();
    });

    // Функция для открытия модального окна
    async function openHomeworkModal(element) {
        const lessonId = element.getAttribute('data-lesson-id');

        try {
            // Показываем индикатор загрузки
            const modalTitle = document.getElementById('homeworkModalTitle');
            if (modalTitle) {
                modalTitle.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Загрузка...';
            }

            // Получаем данные урока через AJAX
            const response = await fetch(scheduleServerData.getLessonDetailsUrl + '?lessonId=' + lessonId);
            const result = await response.json();

            if (result.success) {
                const data = result.data;

                document.getElementById('modalSubject').textContent = data.subject || 'Не указано';
                document.getElementById('modalDate').textContent = data.date || 'Не указана';
                document.getElementById('modalLessonNumber').textContent = data.lessonNumber ? 'Урок ' + data.lessonNumber : 'Не указан';
                document.getElementById('modalTeacher').textContent = data.teacher || 'Не указан';
                document.getElementById('modalClassroom').textContent = data.classroom || 'Не указан';
                document.getElementById('modalLessonTopic').textContent = data.lessonTopic || 'Не указана';
                document.getElementById('modalHomeworkText').textContent = data.homeworkText || 'Не задано';
                document.getElementById('modalLessonId').value = data.lessonId || lessonId;

                // Очищаем предыдущие значения
                const studentAnswer = document.getElementById('studentAnswer');
                const submissionMessage = document.getElementById('submissionMessage');

                if (studentAnswer) {
                    studentAnswer.value = '';
                }
                if (submissionMessage) {
                    submissionMessage.classList.add('d-none');
                    submissionMessage.textContent = '';
                }

                // Восстанавливаем заголовок
                if (modalTitle) {
                    if (scheduleServerData.isParent) {
                        modalTitle.innerHTML = 'Просмотр домашнего задания';
                    } else {
                        modalTitle.innerHTML = 'Домашнее задание';
                    }
                }

                // Открываем модальное окно
                if (homeworkModal) {
                    homeworkModal.show();
                }
            } else {
                showNotification('Ошибка загрузки данных урока: ' + result.message, 'error');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            showNotification('Ошибка загрузки данных урока', 'error');
        }
    }

    // Утилита для показа уведомлений
    function showNotification(message, type = 'info') {
        const container = document.getElementById('notificationContainer');
        if (!container) return;

        const alertClass = type === 'success' ? 'alert-success' :
                          type === 'error' || type === 'danger' ? 'alert-danger' :
                          type === 'warning' ? 'alert-warning' : 'alert-info';

        const icon = type === 'success' ? 'fa-check-circle' :
                     type === 'error' || type === 'danger' ? 'fa-exclamation-circle' :
                     type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';

        const alert = document.createElement('div');
        alert.className = `alert ${alertClass} alert-dismissible fade show`;
        alert.innerHTML = `
            <i class="fas ${icon} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        container.appendChild(alert);

        setTimeout(() => {
            if (alert.parentElement) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 5000);
    }

    // Функция для показа alert внутри формы
    function showAlert(message, type, element) {
        if (!element) return;

        const alertClass = type === 'danger' ? 'alert-danger' :
                          type === 'warning' ? 'alert-warning' : 'alert-info';

        element.className = `alert ${alertClass}`;
        element.textContent = message;
        element.classList.remove('d-none');
    }

    /* Дополнительные функции для улучшения UX */
    function initScheduleScroll() {
        const container = document.querySelector('.schedule-scroll-container');
        const indicator = document.querySelector('.scroll-indicator');

        if (!container || !indicator) return;

        // Прячем индикатор, если прокрутка не нужна
        if (container.scrollWidth <= container.clientWidth) {
            indicator.style.display = 'none';
        }

        // Прячем индикатор при прокрутке
        container.addEventListener('scroll', function() {
            const scrollPercentage = (container.scrollLeft / (container.scrollWidth - container.clientWidth)) * 100;

            if (scrollPercentage > 90) {
                indicator.style.opacity = '0';
                indicator.style.transition = 'opacity 0.3s ease';
            } else {
                indicator.style.opacity = '1';
            }
        });
    }

    // Авто-фокус на текстовое поле при открытии модального окна
    function setupModalAutoFocus() {
        const modal = document.getElementById('homeworkModal');
        if (modal) {
            modal.addEventListener('shown.bs.modal', function() {
                const textarea = document.getElementById('studentAnswer');
                if (textarea) {
                    setTimeout(() => {
                        textarea.focus();
                    }, 300);
                }
            });
        }
    }

    // Автоматически инициализируем адаптивные функции при загрузке
    document.addEventListener('DOMContentLoaded', function() {
        initScheduleScroll();
        setupModalAutoFocus();

        // Адаптивная высота текстового поля
        const textarea = document.getElementById('studentAnswer');
        if (textarea) {
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        }

        // Плавная прокрутка таблицы
        const scheduleContainer = document.querySelector('.schedule-scroll-container');
        if (scheduleContainer && window.innerWidth < 768) {
            scheduleContainer.style.scrollBehavior = 'smooth';
        }
    });
    /*]]>*/
</script>
</body>
</html>